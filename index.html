<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Random Intersection Graph: Schelling & Voter Models</title>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.2/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  </head>
  <body>
    <div class="app-container">
      <!-- Header -->
      <header class="app-header">
        <h1>Random Intersection Graph Simulation</h1>
        <p class="subtitle">Schelling and Voter Model Dynamics</p>
      </header>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Control Panel -->
        <aside class="control-panel">
          <section class="model-selection-section">
            <h3>Model Selection</h3>
            <div id="modelSelection" class="model-selection">
              <!-- Model radio buttons will be added by JavaScript -->
            </div>
            <div class="model-description">
              <p id="modelDescription" class="text-muted">Select a simulation model to begin</p>
            </div>
          </section>

          <section class="parameters-section">
            <h3>Parameters</h3>
            <div class="parameters">
              <!-- Graph Structure -->
              <div class="parameter-group">
                <h4>Graph Structure</h4>
                <label for="n">
                  Number of people (n):
                  <span class="help-icon" data-tooltip="Total number of individuals in the simulation. Higher values create more complex networks but slower computation.">?</span>
                </label>
                <input type="number" id="n" class="parameter-input" min="10" max="1000" value="100" />
                
                <label for="m">
                  Number of clubs (m):
                  <span class="help-icon" data-tooltip="Number of social clubs or groups. People can belong to multiple clubs, creating interconnections in the network.">?</span>
                </label>
                <input type="number" id="m" class="parameter-input" min="1" max="100" value="4" />
              </div>

              <!-- Schelling Model Parameters -->
              <div class="parameter-group schelling-params">
                <h4>Schelling Model</h4>
                <label for="c">
                  Edge creation rate (c):
                  <span class="help-icon" data-tooltip="Controls how quickly people form connections based on opinion similarity. Higher values lead to faster clustering.">?</span>
                </label>
                <input type="number" id="c" class="parameter-input" min="0.1" max="10" step="0.1" value="2.0" />
                
                <label for="gFunction">
                  G-function type:
                  <span class="help-icon" data-tooltip="Determines how opinion similarity affects connection probability: Linear (gradual), Sigmoid (smooth transition), Threshold (sharp cutoff).">?</span>
                </label>
                <select id="gFunction" class="parameter-input">
                  <option value="linear">Linear</option>
                  <option value="sigmoid">Sigmoid</option>
                  <option value="threshold">Threshold</option>
                </select>
                
                <label for="gSteepness">
                  G-function steepness:
                  <span class="help-icon" data-tooltip="Controls the steepness of the G-function. Higher values create more pronounced similarity preferences.">?</span>
                </label>
                <input type="number" id="gSteepness" class="parameter-input" min="0.1" max="10" step="0.1" value="3.0" />
              </div>

              <!-- Graph Generation Parameters -->
              <div class="parameter-group graph-generation-params">
                <h4>Graph Generation</h4>
                <label for="isHomogeneous">
                  <input type="checkbox" id="isHomogeneous" checked> Homogeneous Generation
                  <span class="help-icon" data-tooltip="When enabled, all people and clubs have equal weights. When disabled, allows for different popularity levels.">?</span>
                </label>
                
                <div id="homogeneousParams" class="sub-params">
                  <label for="lambda">
                    Connectivity (λ):
                    <span class="help-icon" data-tooltip="Controls the overall connectivity of the random intersection graph. Higher values create denser networks.">?</span>
                  </label>
                  <input type="number" id="lambda" class="parameter-input" min="0.1" max="10" step="0.1" value="1.0" />
                </div>
                
                <div id="nonHomogeneousParams" class="sub-params" style="display: none;">
                  <label for="individualWeightDist">Individual weight distribution:</label>
                  <select id="individualWeightDist" class="parameter-input">
                    <option value="constant">Constant</option>
                    <option value="uniform">Uniform</option>
                    <option value="poisson">Poisson</option>
                  </select>
                  
                  <label for="groupWeightDist">Group weight distribution:</label>
                  <select id="groupWeightDist" class="parameter-input">
                    <option value="constant">Constant</option>
                    <option value="uniform">Uniform</option>
                    <option value="poisson">Poisson</option>
                  </select>
                </div>
              </div>

              <!-- Voter Model Parameters -->
              <div class="parameter-group voter-params">
                <h4>Voter Model</h4>
                
                <!-- Pairwise Voter Parameters -->
                <div class="voter-pairwise-params" style="display: none;">
                  <label for="lambdaVoter">
                    Update rate (λ):
                    <span class="help-icon" data-tooltip="Rate at which opinion updates occur in pairwise interactions. Higher values lead to faster opinion changes.">?</span>
                  </label>
                  <input type="number" id="lambdaVoter" class="parameter-input" min="0" max="2" step="0.1" value="0.5" />
                  
                  <label for="updateRule">
                    Update rule:
                    <span class="help-icon" data-tooltip="Determines which person in a pair changes their opinion: Random (50/50 chance) or First (always the first person).">?</span>
                  </label>
                  <select id="updateRule" class="parameter-input">
                    <option value="random">Random 50/50</option>
                    <option value="first">First in pair</option>
                  </select>
                </div>
                
                <!-- Group-based Voter Parameters -->
                <div class="voter-group-params">
                  <label for="gamma">
                    Opinion change rate (γ):
                    <span class="help-icon" data-tooltip="Probability that a person changes their opinion when exposed to different opinions in their clubs.">?</span>
                  </label>
                  <input type="number" id="gamma" class="parameter-input" min="0" max="1" step="0.01" value="0.3" />
                  
                  <label for="voterType">
                    Voter type:
                    <span class="help-icon" data-tooltip="Club-based: opinions change based on club majority. Individual-based: opinions change through direct pairwise interactions.">?</span>
                  </label>
                  <select id="voterType" class="parameter-input">
                    <option value="group">Club-based</option>
                    <option value="individual">Individual-based</option>
                  </select>
                  
                  <label for="etaFunction">
                    Opinion change function (η):
                    <span class="help-icon" data-tooltip="Function determining how opinion differences influence change probability: Linear, Sigmoid, Threshold, or Custom.">?</span>
                  </label>
                  <select id="etaFunction" class="parameter-input">
                    <option value="linear">Linear</option>
                    <option value="sigmoid">Sigmoid</option>
                    <option value="threshold">Threshold</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
              </div>

              <!-- SIR Model Parameters -->
              <div class="parameter-group sir-params" style="display: none;">
                <h4>SIR Epidemic Model</h4>
                <label for="betaSIR">Infection rate (β):</label>
                <input type="number" id="betaSIR" class="parameter-input" min="0" max="1" step="0.01" value="0.1" />
                
                <label for="gammaSIR">Recovery rate (γ):</label>
                <input type="number" id="gammaSIR" class="parameter-input" min="0" max="1" step="0.01" value="0.05" />
                
                <label for="opinionTransmissionModifier">Opinion transmission modifier:</label>
                <input type="number" id="opinionTransmissionModifier" class="parameter-input" min="0.1" max="5" step="0.1" value="1.5" />
                
                <label for="initialInfectedCount">Initial infected count:</label>
                <input type="number" id="initialInfectedCount" class="parameter-input" min="1" max="50" value="5" />
              </div>

              <!-- Initial Conditions -->
              <div class="parameter-group">
                <h4>Initial Conditions</h4>
                <label for="initialOpinionSplit">
                  Initial +1 opinion ratio:
                  <span class="help-icon" data-tooltip="Fraction of people who start with +1 opinion. 0.5 means equal split, 0.7 means 70% have +1 opinion.">?</span>
                </label>
                <input type="number" id="initialOpinionSplit" class="parameter-input" min="0" max="1" step="0.01" value="0.5" />
                
                <label for="initialGroupWeights">
                  Club weight distribution:
                  <span class="help-icon" data-tooltip="How club popularity is distributed: Uniform (all equal) or Exponential (few very popular clubs).">?</span>
                </label>
                <select id="initialGroupWeights" class="parameter-input">
                  <option value="uniform">Uniform</option>
                  <option value="exponential">Exponential</option>
                </select>
              </div>
            </div>

            <div class="parameter-actions">
              <button id="applyParams" class="btn btn-primary">Apply Parameters</button>
              <div id="parameterErrors" class="error-messages"></div>
            </div>
          </section>

          <section class="simulation-controls">
            <h3>Simulation Control</h3>
            <div class="controls">
              <div class="turn-controls">
                <button id="takeTurn" class="btn btn-secondary">1 Turn</button>
                <button id="take10Turns" class="btn btn-secondary">10 Turns</button>
                <button id="take100Turns" class="btn btn-secondary">100 Turns</button>
              </div>
              
              <div class="run-controls">
                <button id="startRun" class="btn btn-success">Start Run</button>
                <button id="stopRun" class="btn btn-danger" disabled>Stop Run</button>
              </div>
              
              <div class="reset-controls">
                <button id="resetSim" class="btn btn-warning">Reset</button>
              </div>
              
              <div class="export-controls">
                <h4>Data Export</h4>
                <button id="exportData" class="btn btn-info">Export CSV</button>
                <button id="exportGraph" class="btn btn-info">Export Graph JSON</button>
                <button id="exportConfig" class="btn btn-info">Save Config</button>
                <input type="file" id="importConfig" accept=".json" style="display: none;">
                <button id="loadConfig" class="btn btn-info">Load Config</button>
              </div>
            </div>
            
            <div class="simulation-status">
              <div id="turnCounter" class="turn-counter">Turn: 0</div>
              <div id="parameterDisplay" class="parameter-display"></div>
            </div>
          </section>

          <section class="visualization-controls">
            <h3>Visualization</h3>
            <div class="visualizer-selection">
              <label for="visualizerSelect">Visualizer:</label>
              <select id="visualizerSelect" class="parameter-input">
                <option value="canvas">Canvas (Clubs)</option>
                <option value="graph">Network Graph</option>
                <option value="chart">Time Series</option>
              </select>
            </div>
          </section>

          <section class="legend-section">
            <h3>Legend</h3>
            <div class="legend">
              <div class="legend-item">
                <span class="legend-dot opinion-positive"></span>
                <span>Opinion +1</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot opinion-negative"></span>
                <span>Opinion -1</span>
              </div>
            </div>
          </section>
        </aside>

        <!-- Visualization Area -->
        <main class="visualization-area">
          <div class="visualization-wrapper">
            <canvas id="visualization" width="800" height="600"></canvas>
            <div id="graphContainer" style="display: none; width: 100%; height: 100%;"></div>
            <div id="chartContainer" style="display: none; width: 100%; height: 100%;">
              <canvas id="chartCanvas"></canvas>
            </div>
          </div>
          
          <div class="visualization-info">
            <div id="simulationStats" class="stats-panel">
              <h4>Statistics</h4>
              <div id="statsContent">
                <div class="stat-section">
                  <h5>Network</h5>
                  <div class="stat-item">
                    <span class="stat-label">Total Edges:</span>
                    <span id="totalEdges" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Avg Degree:</span>
                    <span id="averageDegree" class="stat-value">0.00</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Density:</span>
                    <span id="networkDensity" class="stat-value">0.000</span>
                  </div>
                </div>
                
                <div class="stat-section">
                  <h5>Opinions</h5>
                  <div class="stat-item">
                    <span class="stat-label">Opinion +1:</span>
                    <span id="opinionPositive" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Opinion -1:</span>
                    <span id="opinionNegative" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Opinion Ratio:</span>
                    <span id="opinionRatio" class="stat-value">1.00</span>
                  </div>
                </div>
                
                <div class="stat-section">
                  <h5>Dynamics</h5>
                  <div class="stat-item">
                    <span class="stat-label">Segregation Index:</span>
                    <span id="segregationIndex" class="stat-value">0.000</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Convergence:</span>
                    <span id="convergenceMetric" class="stat-value">0.000</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Homophilous Clubs:</span>
                    <span id="homophilousClubs" class="stat-value">0/0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Footer -->
      <footer class="app-footer">
        <p>Based on "Schelling and Voter Model on Random Intersection Graph" research</p>
        <div class="model-info">
          <strong>Current Model:</strong> 
          <span id="currentModelDisplay">Combined</span>
        </div>
      </footer>
    </div>

    <!-- Error/Message Display -->
    <div id="messageOverlay" class="message-overlay" style="display: none;">
      <div class="message-content">
        <h3 id="messageTitle">Message</h3>
        <p id="messageText"></p>
        <button id="messageClose" class="btn btn-primary">Close</button>
      </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/main.js"></script>
  </body>
</html>
